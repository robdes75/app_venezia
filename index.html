<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Mappa Venezia</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
html, body {
  width: 100%;
  height: 100%;
  margin: 0;
  background: #000;
}

#map {
  width: 100%;
  height: 100%;
}

/* ===== SFERA 3D ===== */
.marker-sfera {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  position: relative;
  box-shadow:
    0 4px 8px rgba(0,0,0,0.6),
    inset -2px -3px 4px rgba(0,0,0,0.35);
}

/* riflesso vetro */
.marker-sfera::after {
  content: "";
  position: absolute;
  top: 3px;
  left: 4px;
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: rgba(255,255,255,0.7);
}

/* ROSSO */
.marker-via {
  background: radial-gradient(circle at 30% 30%,
    #ffd6d6,
    #ff2a2a 55%,
    #7a0000 100%);
}

/* BLU */
.marker-note {
  background: radial-gradient(circle at 30% 30%,
    #d6ecff,
    #1e88ff 55%,
    #002f6c 100%);
}

/* UTENTE */
.marker-utente {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%,
    #d9ffd9,
    #00e676 55%,
    #007a33 100%);
  box-shadow:
    0 0 14px rgba(0,230,118,0.9),
    inset -2px -3px 4px rgba(0,0,0,0.35);
}
</style>
</head>

<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ===== MAPPA ===== */
const map = L.map("map", {
  zoomControl: true
});

// vista completa Venezia
map.fitBounds([
  [45.40, 12.20],
  [45.47, 12.38]
]);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 20,
  attribution: "Â© OpenStreetMap"
}).addTo(map);

/* ===== LAYER PUNTI ===== */
const layerPunti = L.layerGroup();

/* ===== CARICA DATI ===== */
fetch("data/punti.json")
  .then(r => r.json())
  .then(data => {
    data.forEach(p => {

      const tipo = p.tipo?.toLowerCase();

      const classe =
        tipo === "note" ? "marker-note" :
        "marker-via";

      const icon = L.divIcon({
        className: "",
        html: `<div class="marker-sfera ${classe}"></div>`,
        iconSize: [20,20],
        iconAnchor: [10,10]
      });

      const m = L.marker([p.lat, p.lon], { icon });

      m.bindPopup(
        `<b>${p.nome}</b><br>${p.descrizione}`
      );

      layerPunti.addLayer(m);
    });
  });

/* ===== MOSTRA SOLO A ZOOM ALTO ===== */
map.on("zoomend", () => {
  if (map.getZoom() >= 17) {
    if (!map.hasLayer(layerPunti)) map.addLayer(layerPunti);
  } else {
    if (map.hasLayer(layerPunti)) map.removeLayer(layerPunti);
  }
});

/* ===== GEOLOCALIZZAZIONE ===== */
map.locate({ watch: true, enableHighAccuracy: true });

map.on("locationfound", e => {
  if (window.userMarker) {
    window.userMarker.setLatLng(e.latlng);
  } else {
    const icon = L.divIcon({
      className: "",
      html: `<div class="marker-utente"></div>`,
      iconSize: [22,22],
      iconAnchor: [11,11]
    });
    window.userMarker = L.marker(e.latlng, { icon }).addTo(map);
  }
});

/* ===== SERVICE WORKER ===== */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
